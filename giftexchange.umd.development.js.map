{"version":3,"file":"giftexchange.umd.development.js","sources":["../src/index.ts"],"sourcesContent":["export interface Person {\n  name: string;\n  group?: string;\n}\n\nexport interface Exclusion {\n  /**\n   * Which property on the Person interface the `subject` refers to when\n   * selecting the current person.\n   *\n   * @example 'name' or 'group'\n   */\n  type: keyof Person;\n  /**\n   * The value of the given type to select the current person.\n   * Internally, we use `person[exclusion.type] === exclusion.subject` to select\n   * the current person.\n   */\n  subject: string;\n  /**\n   * Which property on the Person interface the `subject` refers to when\n   * selecting the excluded person.\n   *\n   * @example 'name' or 'group'\n   */\n  excludedType: keyof Person;\n  /**\n   * The value of the given type to select the current person.\n   * Internally, we use `person[exclusion.excludedType] !== exclusion.excludedSubject`\n   * to check if a the current person is allowed to match with the exclusion rule\n   */\n  excludedSubject: string;\n}\n\nfunction shuffle<T = unknown>(array: T[]) {\n  let i = array.length;\n  let j;\n\n  while (i !== 0) {\n    j = Math.floor(Math.random() * i);\n    i -= 1;\n\n    const swap = array[i];\n    array[i] = array[j];\n    array[j] = swap;\n  }\n\n  return array;\n}\n\nexport function validateMatches(\n  a: Person[],\n  b: Person[],\n  exclusions: Exclusion[] = []\n) {\n  if (a.length !== b.length) return false;\n\n  // pA - person a, pB - person b\n  return a.every((pA, i) => {\n    const pB = b[i];\n    // skip matches that are the same name\n    if (pA.name === pB.name) return false;\n    // skip matches that are in the same group, if groups are defined\n    if ((pA.group || pB.group) && pA.group === pB.group) return false;\n\n    return (\n      exclusions\n        // filter to exclusions of subjects that match pA\n        .filter((exclusion) => pA[exclusion.type] === exclusion.subject)\n        // reject pB if they have an excludedType of excludedValue\n        .every(\n          (exclusion) =>\n            pB[exclusion.excludedType] !== exclusion.excludedSubject\n        )\n    );\n  });\n}\n\nexport function calculate(people: Person[], exclusions?: Exclusion[]): Person[];\nexport function calculate(\n  people: Person[],\n  options?: { exclusions?: Exclusion[]; timeout?: number }\n): Person[];\n\nexport function calculate(\n  people: Person[],\n  exclusionsOrOptions?:\n    | { exclusions?: Exclusion[]; timeout?: number }\n    | Exclusion[]\n): Person[] {\n  if (people.length < 2) {\n    return people.slice(0);\n  }\n  let exclusions: Exclusion[];\n  let timeout = 1000;\n  if (Array.isArray(exclusionsOrOptions)) {\n    exclusions = exclusionsOrOptions;\n  } else {\n    exclusions = exclusionsOrOptions?.exclusions ?? [];\n    timeout = exclusionsOrOptions?.timeout ?? 1000;\n  }\n\n  let buffer1: Person[] = [];\n  let buffer2: Person[] = [];\n\n  // https://www.youtube.com/watch?v=5kC5k5QBqcc\n  const shuffleAndSlide = () => {\n    const shuffled = shuffle(people.slice());\n    buffer1 = shuffled.slice(0);\n    buffer2 = shuffled.slice(0);\n\n    // slide each element over by one on buffer2.\n    // we check the people array before this, and are mutating buffers for\n    // performance, so it is safe to use a non-null assertion here.\n    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n    buffer2.push(buffer2.shift()!);\n  };\n\n  const startTime = Date.now();\n  const testDerangement: typeof validateMatches = (...args) => {\n    // prevent infinite loops when no combination is found\n    if (Date.now() - startTime > timeout) {\n      const error = new Error(\"No combinations found\");\n      error.name = \"GiftExchangeError\";\n      throw error;\n    }\n    return validateMatches(...args);\n  };\n\n  shuffleAndSlide();\n  while (!testDerangement(buffer1, buffer2, exclusions)) {\n    shuffleAndSlide();\n  }\n\n  // map back to the order of the given person argument\n  return people.map((p) => {\n    const personIndex = buffer1.findIndex((match) => match.name === p.name);\n    return buffer2[personIndex];\n  });\n}\n"],"names":[],"mappings":";;;;;;EAkCA,SAAS,OAAO,CAAc,KAAU,EAAA;EACtC,IAAA,IAAI,CAAC,GAAG,KAAK,CAAC,MAAM,CAAC;EACrB,IAAA,IAAI,CAAC,CAAC;MAEN,OAAO,CAAC,KAAK,CAAC,EAAE;EACd,QAAA,CAAC,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,EAAE,GAAG,CAAC,CAAC,CAAC;UAClC,CAAC,IAAI,CAAC,CAAC;EAEP,QAAA,MAAM,IAAI,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC;UACtB,KAAK,CAAC,CAAC,CAAC,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC;EACpB,QAAA,KAAK,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC;EACjB,KAAA;EAED,IAAA,OAAO,KAAK,CAAC;EACf,CAAC;EAEK,SAAU,eAAe,CAC7B,CAAW,EACX,CAAW,EACX,aAA0B,EAAE,EAAA;EAE5B,IAAA,IAAI,CAAC,CAAC,MAAM,KAAK,CAAC,CAAC,MAAM;EAAE,QAAA,OAAO,KAAK,CAAC;;MAGxC,OAAO,CAAC,CAAC,KAAK,CAAC,CAAC,EAAE,EAAE,CAAC,KAAI;EACvB,QAAA,MAAM,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;;EAEhB,QAAA,IAAI,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI;EAAE,YAAA,OAAO,KAAK,CAAC;;EAEtC,QAAA,IAAI,CAAC,EAAE,CAAC,KAAK,IAAI,EAAE,CAAC,KAAK,KAAK,EAAE,CAAC,KAAK,KAAK,EAAE,CAAC,KAAK;EAAE,YAAA,OAAO,KAAK,CAAC;EAElE,QAAA,QACE,UAAU;;EAEP,aAAA,MAAM,CAAC,CAAC,SAAS,KAAK,EAAE,CAAC,SAAS,CAAC,IAAI,CAAC,KAAK,SAAS,CAAC,OAAO,CAAC;;EAE/D,aAAA,KAAK,CACJ,CAAC,SAAS,KACR,EAAE,CAAC,SAAS,CAAC,YAAY,CAAC,KAAK,SAAS,CAAC,eAAe,CAC3D,EACH;EACJ,KAAC,CAAC,CAAC;EACL,CAAC;EAQe,SAAA,SAAS,CACvB,MAAgB,EAChB,mBAEe,EAAA;;EAEf,IAAA,IAAI,MAAM,CAAC,MAAM,GAAG,CAAC,EAAE;EACrB,QAAA,OAAO,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;EACxB,KAAA;EACD,IAAA,IAAI,UAAuB,CAAC;MAC5B,IAAI,OAAO,GAAG,IAAI,CAAC;EACnB,IAAA,IAAI,KAAK,CAAC,OAAO,CAAC,mBAAmB,CAAC,EAAE;UACtC,UAAU,GAAG,mBAAmB,CAAC;EAClC,KAAA;EAAM,SAAA;UACL,UAAU,GAAG,CAAA,EAAA,GAAA,mBAAmB,KAAnB,IAAA,IAAA,mBAAmB,KAAnB,KAAA,CAAA,GAAA,KAAA,CAAA,GAAA,mBAAmB,CAAE,UAAU,MAAI,IAAA,IAAA,EAAA,KAAA,KAAA,CAAA,GAAA,EAAA,GAAA,EAAE,CAAC;UACnD,OAAO,GAAG,CAAA,EAAA,GAAA,mBAAmB,KAAnB,IAAA,IAAA,mBAAmB,KAAnB,KAAA,CAAA,GAAA,KAAA,CAAA,GAAA,mBAAmB,CAAE,OAAO,MAAI,IAAA,IAAA,EAAA,KAAA,KAAA,CAAA,GAAA,EAAA,GAAA,IAAI,CAAC;EAChD,KAAA;MAED,IAAI,OAAO,GAAa,EAAE,CAAC;MAC3B,IAAI,OAAO,GAAa,EAAE,CAAC;;MAG3B,MAAM,eAAe,GAAG,MAAK;UAC3B,MAAM,QAAQ,GAAG,OAAO,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC,CAAC;EACzC,QAAA,OAAO,GAAG,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;EAC5B,QAAA,OAAO,GAAG,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;;;;;UAM5B,OAAO,CAAC,IAAI,CAAC,OAAO,CAAC,KAAK,EAAG,CAAC,CAAC;EACjC,KAAC,CAAC;EAEF,IAAA,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;EAC7B,IAAA,MAAM,eAAe,GAA2B,CAAC,GAAG,IAAI,KAAI;;UAE1D,IAAI,IAAI,CAAC,GAAG,EAAE,GAAG,SAAS,GAAG,OAAO,EAAE;EACpC,YAAA,MAAM,KAAK,GAAG,IAAI,KAAK,CAAC,uBAAuB,CAAC,CAAC;EACjD,YAAA,KAAK,CAAC,IAAI,GAAG,mBAAmB,CAAC;EACjC,YAAA,MAAM,KAAK,CAAC;EACb,SAAA;EACD,QAAA,OAAO,eAAe,CAAC,GAAG,IAAI,CAAC,CAAC;EAClC,KAAC,CAAC;EAEF,IAAA,eAAe,EAAE,CAAC;MAClB,OAAO,CAAC,eAAe,CAAC,OAAO,EAAE,OAAO,EAAE,UAAU,CAAC,EAAE;EACrD,QAAA,eAAe,EAAE,CAAC;EACnB,KAAA;;EAGD,IAAA,OAAO,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC,KAAI;EACtB,QAAA,MAAM,WAAW,GAAG,OAAO,CAAC,SAAS,CAAC,CAAC,KAAK,KAAK,KAAK,CAAC,IAAI,KAAK,CAAC,CAAC,IAAI,CAAC,CAAC;EACxE,QAAA,OAAO,OAAO,CAAC,WAAW,CAAC,CAAC;EAC9B,KAAC,CAAC,CAAC;EACL;;;;;;;;;"}