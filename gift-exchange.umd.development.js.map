{"version":3,"file":"gift-exchange.umd.development.js","sources":["../src/utils.ts","../src/derange.ts"],"sourcesContent":["export interface Person {\n  name: string;\n  group?: string;\n}\n\nexport interface Exclusion {\n  /**\n   * Which property on the Person interface the `subject` refers to when\n   * selecting the current person.\n   *\n   * @example 'name' or 'group'\n   */\n  type: keyof Person;\n  /**\n   * The value of the given type to select the current person.\n   * Internally, we use `person[exclusion.type] === exclusion.subject` to select\n   * the current person.\n   */\n  subject: string;\n  /**\n   * Which property on the Person interface the `subject` refers to when\n   * selecting the excluded person.\n   *\n   * @example 'name' or 'group'\n   */\n  excludedType: keyof Person;\n  /**\n   * The value of the given type to select the current person.\n   * Internally, we use `person[exclusion.excludedType] !== exclusion.excludedSubject`\n   * to check if a the current person is allowed to match with the exclusion rule\n   */\n  excludedSubject: string;\n}\n\nexport const personArrayOfLength = (length: number): Person[] =>\n  new Array(length).fill(true).map((_, i) => ({ name: '' + (i + 1) }));\n\nexport const shuffle = <T = any>(array: T[]) => {\n  let i = array.length;\n  let j;\n\n  while (i !== 0) {\n    j = Math.floor(Math.random() * i);\n    i -= 1;\n\n    const swap = array[i];\n    array[i] = array[j];\n    array[j] = swap;\n  }\n\n  return array;\n};\n\nexport class DerangementError extends Error {\n  constructor(...params: Parameters<ErrorConstructor>) {\n    super(...params);\n    Object.setPrototypeOf(this, new.target.prototype);\n    this.name = 'DerangementError';\n  }\n}\n","import { DerangementError, Exclusion, Person, shuffle } from './utils';\n\nexport type ValidateMatches = (\n  a: Person[],\n  b: Person[],\n  exclusions?: Exclusion[]\n) => boolean;\n\nexport const validateMatches: ValidateMatches = (\n  a,\n  b,\n  exclusions = [] as Exclusion[]\n) => {\n  if (a.length !== b.length) return false;\n\n  // pA - person a, pB - person b\n  return a.every((pA, i) => {\n    const pB = b[i];\n    // skip matches that are the same name\n    if (pA.name === pB.name) return false;\n    // skip matches that are in the same group, if groups are defined\n    if ((pA.group || pB.group) && pA.group === pB.group) return false;\n\n    return (\n      exclusions\n        // filter to exclusions of subjects that match pA\n        .filter(exclusion => pA[exclusion.type] === exclusion.subject)\n        // reject pB if they have an excludedType of excludedValue\n        .every(\n          exclusion => pB[exclusion.excludedType] !== exclusion.excludedSubject\n        )\n    );\n  });\n};\n\nexport function derange(people: Person[], exclusions?: Exclusion[]): Person[];\nexport function derange(\n  people: Person[],\n  options?: { exclusions?: Exclusion[]; timeout?: number }\n): Person[];\n\nexport function derange(\n  people: Person[],\n  exclusionsOrOptions?:\n    | { exclusions?: Exclusion[]; timeout?: number }\n    | Exclusion[]\n): Person[] {\n  if (people.length < 2) {\n    return people.slice(0);\n  }\n  let exclusions: Exclusion[];\n  let timeout = 1000;\n  if (Array.isArray(exclusionsOrOptions)) {\n    exclusions = exclusionsOrOptions;\n  } else {\n    exclusions = exclusionsOrOptions?.exclusions ?? [];\n    timeout = exclusionsOrOptions?.timeout ?? 1000;\n  }\n\n  let buffer1: Person[] = [];\n  let buffer2: Person[] = [];\n\n  // https://www.youtube.com/watch?v=5kC5k5QBqcc\n  const shuffleAndSlide = () => {\n    const shuffled = shuffle([...people]);\n    buffer1 = shuffled.slice(0);\n    buffer2 = shuffled.slice(0);\n\n    // slide each element over by one on buffer2\n    buffer2.push(buffer2.shift()!);\n  };\n\n  const startTime = Date.now();\n  const testDerangement: ValidateMatches = (...args): boolean => {\n    // prevent infinite loops when no combination is found\n    if (Date.now() - startTime > timeout)\n      throw new DerangementError('No derangement found');\n    return validateMatches(...args);\n  };\n\n  shuffleAndSlide();\n  while (!testDerangement(buffer1, buffer2, exclusions)) {\n    shuffleAndSlide();\n  }\n\n  // map back to the order of the given person argument\n  return people.map(p => {\n    const personIndex = buffer1.findIndex(match => match.name === p.name);\n    return buffer2[personIndex];\n  });\n}\n\nexport function calculate(people: Person[], exclusions?: Exclusion[]): Promise<Person[]>;\nexport function calculate(\n  people: Person[],\n  options?: { exclusions?: Exclusion[]; timeout?: number }\n): Promise<Person[]>;\n/**\n * @deprecated\n * This is thread blocking, even when in wrapped in a Promise\n * A better non-blocking approach would be to wrap the call in a WebWorker\n */\nexport function calculate(\n  people: Person[],\n  exclusionsOrOptions?: any\n): Promise<Person[]> {\n  return new Promise((resolve, reject) => {\n    try {\n      resolve(derange(people, exclusionsOrOptions));\n    } catch (e) {\n      reject(e);\n    }\n  });\n}\n"],"names":["shuffle","array","i","length","j","Math","floor","random","swap","DerangementError","params","Object","setPrototypeOf","prototype","name","Error","validateMatches","a","b","exclusions","every","pA","pB","group","filter","exclusion","type","subject","excludedType","excludedSubject","derange","people","exclusionsOrOptions","slice","timeout","Array","isArray","buffer1","buffer2","shuffleAndSlide","shuffled","push","shift","startTime","Date","now","testDerangement","map","p","personIndex","findIndex","match","calculate","Promise","resolve","reject","e"],"mappings":"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"}